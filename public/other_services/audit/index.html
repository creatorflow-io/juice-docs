<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.111.3">
    <meta name="description" content="">


    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Audit services :: Juice&#39;s documentation</title>

    
    <link href="/css/nucleus.css?1694751655" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1694751655" rel="stylesheet">
    <link href="/css/hybrid.css?1694751655" rel="stylesheet">
    <link href="/css/featherlight.min.css?1694751655" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1694751655" rel="stylesheet">
    <link href="/css/auto-complete.css?1694751655" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1694751655" rel="stylesheet">
    <link href="/css/theme.css?1694751655" rel="stylesheet">
    <link href="/css/tabs.css?1694751655" rel="stylesheet">
    <link href="/css/hugo-theme.css?1694751655" rel="stylesheet">
    
    <link href="/css/theme-mine.css?1694751655" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1694751655"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/other_services/audit/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1694751655"></script>
<script type="text/javascript" src="/js/auto-complete.js?1694751655"></script>
<script type="text/javascript">
    
        var baseurl = "http:\/\/example.org\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1694751655"></script>

    
  </div>
  
    <section id="homelinks">
      <ul>
        <li>
            <a class="padding" href='/'><i class='fas fa-home'></i> Home</a>
        </li>
      </ul>
    </section>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/overview/" title="Overview" class="dd-item
        
        
        
        ">
      <a href="/overview/">
          <b>1. </b>Overview
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/overview/purpose/" title="Purposes" class="dd-item
        
        
        
        ">
      <a href="/overview/purpose/">
          Purposes
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/overview/app_model/" title="Application models" class="dd-item
        
        
        
        ">
      <a href="/overview/app_model/">
          Application models
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/quickstart/" title="Quickstarts" class="dd-item
        
        
        
        ">
      <a href="/quickstart/">
          <b>2. </b>Quickstarts
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/quickstart/overview/" title="Overview" class="dd-item
        
        
        
        ">
      <a href="/quickstart/overview/">
          Overview
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/quickstart/domain/" title="Domain" class="dd-item
        
        
        
        ">
      <a href="/quickstart/domain/">
          Domain
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/quickstart/infrastructure/" title="Infrastructure" class="dd-item
        
        
        
        ">
      <a href="/quickstart/infrastructure/">
          Infrastructure
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/quickstart/contracts/" title="API Contracts" class="dd-item
        
        
        
        ">
      <a href="/quickstart/contracts/">
          API Contracts
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/quickstart/api/" title="API" class="dd-item
        
        
        
        ">
      <a href="/quickstart/api/">
          API
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/quickstart/microservice/" title="Microservice" class="dd-item
        
        
        
        ">
      <a href="/quickstart/microservice/">
          Microservice
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/quickstart/mono/" title="Monolithic" class="dd-item
        
        
        
        ">
      <a href="/quickstart/mono/">
          Monolithic
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/core/" title="Core features" class="dd-item
        
        
        
        ">
      <a href="/core/">
          <b>3. </b>Core features
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/core/overview/" title="Overview" class="dd-item
        
        
        
        ">
      <a href="/core/overview/">
          Overview
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/logging/" title="Logging" class="dd-item
        
        
        
        ">
      <a href="/core/logging/">
          Logging
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/configuration/" title="Configuration" class="dd-item
        
        
        
        ">
      <a href="/core/configuration/">
          Configuration
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/options/" title="Options" class="dd-item
        
        
        
        ">
      <a href="/core/options/">
          Options
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/swagger/" title="Swagger" class="dd-item
        
        
        
        ">
      <a href="/core/swagger/">
          Swagger
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/mediator/" title="Mediator" class="dd-item
        
        
        
        ">
      <a href="/core/mediator/">
          Mediator
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/eventbus/" title="Event bus" class="dd-item
        
        
        
        ">
      <a href="/core/eventbus/">
          Event bus
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/entityframework/" title="Entity framework" class="dd-item
        
        
        
        ">
      <a href="/core/entityframework/">
          Entity framework
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/integration/" title="Integration service" class="dd-item
        
        
        
        ">
      <a href="/core/integration/">
          Integration service
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/xunit/" title="xUnit" class="dd-item
        
        
        
        ">
      <a href="/core/xunit/">
          xUnit
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/core/xunit/di/" title="Dependency Injection" class="dd-item
        
        
        
        ">
      <a href="/core/xunit/di/">
          Dependency Injection
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/xunit/logging/" title="Logging" class="dd-item
        
        
        
        ">
      <a href="/core/xunit/logging/">
          Logging
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/xunit/priority/" title="Priority" class="dd-item
        
        
        
        ">
      <a href="/core/xunit/priority/">
          Priority
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/xunit/ci_ignore/" title="CI-Ignore" class="dd-item
        
        
        
        ">
      <a href="/core/xunit/ci_ignore/">
          CI-Ignore
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/multitenant/" title="Multi-tenant" class="dd-item
        
        
        
        ">
      <a href="/core/multitenant/">
          Multi-tenant
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/modular/" title="Modular" class="dd-item
        
        
        
        ">
      <a href="/core/modular/">
          Modular
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/bg_service/" title="Background service" class="dd-item
        
        
        
        ">
      <a href="/bg_service/">
          <b>4. </b>Background service
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/bg_service/logging/" title="Logging" class="dd-item
        
        
        
        ">
      <a href="/bg_service/logging/">
          Logging
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/file_storage/" title="File_storage" class="dd-item
        
        
        
        ">
      <a href="/file_storage/">
          <b>5. </b>File_storage
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/other_services/" title="Other services" class="dd-item
        parent
        
        
        ">
      <a href="/other_services/">
          <b>7. </b>Other services
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/other_services/audit/" title="Audit services" class="dd-item
        
        active
        
        ">
      <a href="/other_services/audit/">
          Audit services
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li>
                  <a class="padding" href="https://github.com/creatorflow-io/Juice"><i class='fab fa-github'></i> Github repo</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                  
                  
                  
                  <div id="top-github-link">
                    <a class="github-link" title='Edit this page' href="https://github.com/creatorflow-io/juice-docs/tree/master/content/other_services/audit/_index.md" target="blank">
                      <i class="fas fa-code-branch"></i>
                      <span id="top-github-link-text">Edit this page</span>
                    </a>
                  </div>
                  
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'></a> > <a href='/other_services/'>Other services</a> > Audit services
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#data-audit">Data audit</a></li>
        <li><a href="#default-audit-service">Default audit service</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Audit services
            </h1>
          

        



	<h3 id="data-audit">Data audit</h3>
<p>We already have a data audit framework based on EF Core and fully implemented in the <em>DbContextBase</em> abstract class. It will send a <em>DataEvent</em> via MediatR&rsquo;s notification, the object contains:</p>
<ul>
<li><em>Name</em>: type of change (<strong>Inserted/ Modified/ Deleted</strong>)</li>
<li><em>AuditRecord</em>: contains all needed data audit information (<strong>User, Database, Schema, Table, KeyValues, OriginalValues, CurrentValues</strong>)</li>
</ul>
<h4 id="what-will-you-do">What will you do?</h4>
<ol>
<li>Mark entities as auditable
Only entities marked as auditable will have audit events triggeredd on their changes. You can mark an entity as auditable by two ways:</li>
</ol>
<ul>
<li>Inherit from <em>IAuditable</em> interface</li>
<li>Call <strong>IsAuditable()</strong> on <em>EntityTypeBuilder</em> for your entity</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SampleEntity</span>: IAuditable{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// OR</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Inside DbContext</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> OnModelCreating(ModelBuilder modelBuilder)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        modelBuilder.Entity&lt;SampleEntity&gt;(entity =&gt;
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>            entity.IsAuditable();
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><ol start="2">
<li>Inject audit process into the DbContext</li>
</ol>
<p><strong>If your DbContext inherits from the abstract class <em>DbContextBase</em>, please bypass this step</strong>. But if you want to implement a DbContext yourself, it must inherit <em>IAuditableDbContext</em> interface and you can follow these steps to configure:</p>
<ul>
<li>
<p>ConfigureServices: we need <em>User</em> info and <em>IMediator</em> service to function.</p>
<ul>
<li>If you are using pooled DbContext, your DbContext&rsquo;s <em>constructor</em> must clean, it must contains only DbContextOptions argurment. So we will use PooledDbContextFactory pattern and implement a factory that inherit <em>IDbContextFactory</em> and call ConfigureServices() inside.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Dependency injection</span>
</span></span><span style="display:flex;"><span>    services.AddPooledDbContextFactory&lt;SampleDbContext&gt;();
</span></span><span style="display:flex;"><span>    services.AddScoped&lt;SampleDbContextScopedFactory&gt;();
</span></span><span style="display:flex;"><span>    services.AddScoped(sp =&gt; sp.GetRequiredService&lt;SampleDbContextScopedFactory&gt;().CreateDbContext());
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#75715e">// Factory</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SampleDbContextScopedFactory</span> : IDbContextFactory&lt;SampleDbContext&gt;
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> IDbContextFactory&lt;SampleDbContext&gt; _pooledFactory;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">readonly</span> IServiceProvider _serviceProvider;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> SampleDbContextScopedFactory(
</span></span><span style="display:flex;"><span>            IDbContextFactory&lt;SampleDbContext&gt; pooledFactory,
</span></span><span style="display:flex;"><span>            IServiceProvider serviceProvider)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            _pooledFactory = pooledFactory;
</span></span><span style="display:flex;"><span>            _serviceProvider = serviceProvider;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> SampleDbContext CreateDbContext()
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> context = _pooledFactory.CreateDbContext();
</span></span><span style="display:flex;"><span>            context.ConfigureServices(_serviceProvider);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> context;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><ul>
<li>Otherwise, we can call <em>ConfigureServices()</em> in DbContext&rsquo;s constructor directly.</li>
</ul>
</li>
<li>
<p>Configure model to mark auditable entities.</p>
<ul>
<li>Call <em>modelBuilder.ConfigureAuditableEntities()</em> inside <em>OnModelCreating(ModelBuilder modelBuilder)</em> to mark all entities that inherit <em>IAuditable</em> as auditable.</li>
<li>Call <strong>IsAuditable()</strong> on <em>EntityTypeBuilder</em> for your entity (step 1).</li>
</ul>
</li>
<li>
<p>Store the audit information before you <em>SaveChanges</em> and finally dispatch data change events.</p>
</li>
</ul>
<p>The code block below is an example for an auditable DbContext.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SampleDbContext</span> : DbContext,
</span></span><span style="display:flex;"><span>        IAuditableDbContext
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#region Auditable context</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">string?</span> User { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> IHttpContextAccessor? _httpContextAccessor;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> List&lt;AuditEntry&gt;? PendingAuditEntries { <span style="color:#66d9ef">get</span>; <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">set</span>; }
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">#</span>endregion
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">protected</span> IMediator? _mediator;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">protected</span> ILogger? _logger;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">protected</span> DbOptions? _options;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// Please call &lt;c&gt;ConfigureServices(IServiceProvider serviceProvider)&lt;/c&gt; directly in your constructor</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// or inside &lt;c&gt;IDbContextFactory.CreateDbContext()&lt;/c&gt; if you are using PooledDbContextFactory&lt;/para&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// to init internal services&lt;/para&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;/summary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/// &lt;param name=&#34;options&#34;&gt;&lt;/param&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> SampleDbContext(DbContextOptions options)
</span></span><span style="display:flex;"><span>            : <span style="color:#66d9ef">base</span>(options)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> ConfigureServices(IServiceProvider serviceProvider)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Get user from HttpContext</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> httpContextAccessor = serviceProvider.GetService&lt;IHttpContextAccessor&gt;();
</span></span><span style="display:flex;"><span>            User = httpContextAccessor?.HttpContext?.User?.FindFirst(ClaimTypes.Name)?.Value;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                _mediator = serviceProvider.GetService&lt;IMediator&gt;();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> OnModelCreating(ModelBuilder modelBuilder)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">base</span>.OnModelCreating(modelBuilder);
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Mark all entities that inherit IAuditable as auditable</span>
</span></span><span style="display:flex;"><span>            modelBuilder.ConfigureAuditableEntities();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// OR/ AND</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Mark specified entities as auditable</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            modelBuilder.Entity&lt;SampleEntity&gt;(entity =&gt;
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                ...
</span></span><span style="display:flex;"><span>                entity.IsAuditable();
</span></span><span style="display:flex;"><span>                ...
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> ProcessingChanges()
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (PendingAuditEntries == <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>            { <span style="color:#66d9ef">return</span>; }
</span></span><span style="display:flex;"><span>            _mediator.DispatchDataChangeEventsAsync(<span style="color:#66d9ef">this</span>).GetAwaiter().GetResult();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">async</span> Task&lt;<span style="color:#66d9ef">int</span>&gt; SaveChangesAsync(<span style="color:#66d9ef">bool</span> acceptAllChangesOnSuccess, CancellationToken cancellationToken = <span style="color:#66d9ef">default</span>(CancellationToken))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.SetAuditInformation(_logger);
</span></span><span style="display:flex;"><span>            PendingAuditEntries = _mediator != <span style="color:#66d9ef">null</span> ? <span style="color:#66d9ef">this</span>.TrackingChanges(_logger)?.ToList() : <span style="color:#66d9ef">default</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">base</span>.SaveChangesAsync(acceptAllChangesOnSuccess, cancellationToken);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">finally</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                ProcessingChanges();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">int</span> SaveChanges(<span style="color:#66d9ef">bool</span> acceptAllChangesOnSuccess)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.SetAuditInformation(_logger);
</span></span><span style="display:flex;"><span>            PendingAuditEntries = _mediator != <span style="color:#66d9ef">null</span> ? <span style="color:#66d9ef">this</span>.TrackingChanges(_logger)?.ToList() : <span style="color:#66d9ef">default</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">base</span>.SaveChanges(acceptAllChangesOnSuccess);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">finally</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                ProcessingChanges();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><ol start="3">
<li>Handle DataEvent</li>
</ol>
<ul>
<li>Implement your own handler by inheriting <em>MediatR.INotificationHandler&lt;DataEvent&gt;</em>, so you can store anything you need proactively.</li>
<li>Use default audit service that we provided below.</li>
</ul>
<h3 id="default-audit-service">Default audit service</h3>
<p>In this part, we provide not only data audit service but access logging service.</p>
<h4 id="core-concept">Core concept</h4>
<ol>
<li>AuditContext</li>
</ol>
<p>The AuditContext contains information about user access log, data audit entries. It will be initialized while a request is starting, be fulfilled while the request pipeline is invoking, and be committed by the <em>IAuditService</em> when the request pipeline is finished.</p>
<ol start="2">
<li>IAuditContextAccessor</li>
</ol>
<p>The accessor to access AuditContext in the scope.</p>
<ol start="3">
<li>IAuditService</li>
</ol>
<p>The service that processes the audited information to store or send it to other systems.</p>
<ol start="4">
<li>AuditMiddleware</li>
</ol>
<p>The middleware that inits the AuditContext at the start of the request. It also collects the important information about the request:</p>
<ul>
<li><em>User</em>, <em>DateTime</em>, <em>Action</em></li>
<li><strong>RequestInfo</strong>: <em>RequestId</em>, <em>Headers</em>, <em>Host</em>, <em>Method</em>, <em>Path</em>, <em>RemoteIpAddress</em></li>
<li><strong>ServerInfo</strong>: <em>MachineName</em>, <em>OSVersion</em>, <em>SoftwareVersion</em>, <em>AppName</em></li>
<li><strong>ResponseInfo</strong>: <em>StatusCode</em>, <em>Headers</em>, <em>ElapsedMilliseconds</em>.
<ul>
<li>The <em>Data</em> was intended to be filled by other middleware that you will implement yourself.</li>
<li>The <em>Message</em>, <em>Error</em> may be set by this middleware if an exception was thrown while invoking the next steps of the pipeline and there is no other middleware filling it. Otherwise, it may be filled by a custom middleware like the <em>Data</em>.</li>
</ul>
</li>
</ul>
<p>It must be placed after <em>Authentication</em> middleware to have <em>User</em> information.</p>
<p>The figure below is the request processing flow with AuditMiddleware injected.</p>
<figure><img src="/images/services/Audit-process.svg"/><figcaption>
            <h4>Audit process</h4>
        </figcaption>
</figure>






<footer class=" footline" >
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="/other_services/" title="Other services"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/overview/" title="Overview" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1694751655"></script>
    <script src="/js/perfect-scrollbar.min.js?1694751655"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1694751655"></script>
    <script src="/js/jquery.sticky.js?1694751655"></script>
    <script src="/js/featherlight.min.js?1694751655"></script>
    <script src="/js/highlight.pack.js?1694751655"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1694751655"></script>
    <script src="/js/learn.js?1694751655"></script>
    <script src="/js/hugo-learn.js?1694751655"></script>
    
        
            <script src="/mermaid/mermaid.js?1694751655"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>

<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.111.3">
    <meta name="description" content="">


    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Event bus :: Juice&#39;s documentation</title>

    
    <link href="/css/nucleus.css?1694751655" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1694751655" rel="stylesheet">
    <link href="/css/hybrid.css?1694751655" rel="stylesheet">
    <link href="/css/featherlight.min.css?1694751655" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1694751655" rel="stylesheet">
    <link href="/css/auto-complete.css?1694751655" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1694751655" rel="stylesheet">
    <link href="/css/theme.css?1694751655" rel="stylesheet">
    <link href="/css/tabs.css?1694751655" rel="stylesheet">
    <link href="/css/hugo-theme.css?1694751655" rel="stylesheet">
    
    <link href="/css/theme-mine.css?1694751655" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1694751655"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/core/eventbus/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1694751655"></script>
<script type="text/javascript" src="/js/auto-complete.js?1694751655"></script>
<script type="text/javascript">
    
        var baseurl = "http:\/\/example.org\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1694751655"></script>

    
  </div>
  
    <section id="homelinks">
      <ul>
        <li>
            <a class="padding" href='/'><i class='fas fa-home'></i> Home</a>
        </li>
      </ul>
    </section>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/overview/" title="Overview" class="dd-item
        
        
        
        ">
      <a href="/overview/">
          <b>1. </b>Overview
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/overview/purpose/" title="Purposes" class="dd-item
        
        
        
        ">
      <a href="/overview/purpose/">
          Purposes
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/overview/app_model/" title="Application models" class="dd-item
        
        
        
        ">
      <a href="/overview/app_model/">
          Application models
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/quickstart/" title="Quickstarts" class="dd-item
        
        
        
        ">
      <a href="/quickstart/">
          <b>2. </b>Quickstarts
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/quickstart/overview/" title="Overview" class="dd-item
        
        
        
        ">
      <a href="/quickstart/overview/">
          Overview
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/quickstart/domain/" title="Domain" class="dd-item
        
        
        
        ">
      <a href="/quickstart/domain/">
          Domain
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/quickstart/infrastructure/" title="Infrastructure" class="dd-item
        
        
        
        ">
      <a href="/quickstart/infrastructure/">
          Infrastructure
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/quickstart/contracts/" title="API Contracts" class="dd-item
        
        
        
        ">
      <a href="/quickstart/contracts/">
          API Contracts
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/quickstart/api/" title="API" class="dd-item
        
        
        
        ">
      <a href="/quickstart/api/">
          API
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/quickstart/microservice/" title="Microservice" class="dd-item
        
        
        
        ">
      <a href="/quickstart/microservice/">
          Microservice
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/quickstart/mono/" title="Monolithic" class="dd-item
        
        
        
        ">
      <a href="/quickstart/mono/">
          Monolithic
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/core/" title="Core features" class="dd-item
        parent
        
        
        ">
      <a href="/core/">
          <b>3. </b>Core features
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/core/overview/" title="Overview" class="dd-item
        
        
        
        ">
      <a href="/core/overview/">
          Overview
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/logging/" title="Logging" class="dd-item
        
        
        
        ">
      <a href="/core/logging/">
          Logging
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/configuration/" title="Configuration" class="dd-item
        
        
        
        ">
      <a href="/core/configuration/">
          Configuration
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/options/" title="Options" class="dd-item
        
        
        
        ">
      <a href="/core/options/">
          Options
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/swagger/" title="Swagger" class="dd-item
        
        
        
        ">
      <a href="/core/swagger/">
          Swagger
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/mediator/" title="Mediator" class="dd-item
        
        
        
        ">
      <a href="/core/mediator/">
          Mediator
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/eventbus/" title="Event bus" class="dd-item
        
        active
        
        ">
      <a href="/core/eventbus/">
          Event bus
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/entityframework/" title="Entity framework" class="dd-item
        
        
        
        ">
      <a href="/core/entityframework/">
          Entity framework
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/integration/" title="Integration service" class="dd-item
        
        
        
        ">
      <a href="/core/integration/">
          Integration service
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/xunit/" title="xUnit" class="dd-item
        
        
        
        ">
      <a href="/core/xunit/">
          xUnit
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/core/xunit/di/" title="Dependency Injection" class="dd-item
        
        
        
        ">
      <a href="/core/xunit/di/">
          Dependency Injection
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/xunit/logging/" title="Logging" class="dd-item
        
        
        
        ">
      <a href="/core/xunit/logging/">
          Logging
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/xunit/priority/" title="Priority" class="dd-item
        
        
        
        ">
      <a href="/core/xunit/priority/">
          Priority
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/xunit/ci_ignore/" title="CI-Ignore" class="dd-item
        
        
        
        ">
      <a href="/core/xunit/ci_ignore/">
          CI-Ignore
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/multitenant/" title="Multi-tenant" class="dd-item
        
        
        
        ">
      <a href="/core/multitenant/">
          Multi-tenant
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/core/modular/" title="Modular" class="dd-item
        
        
        
        ">
      <a href="/core/modular/">
          Modular
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/bg_service/" title="Background service" class="dd-item
        
        
        
        ">
      <a href="/bg_service/">
          <b>4. </b>Background service
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/bg_service/logging/" title="Logging" class="dd-item
        
        
        
        ">
      <a href="/bg_service/logging/">
          Logging
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/file_storage/" title="File_storage" class="dd-item
        
        
        
        ">
      <a href="/file_storage/">
          <b>5. </b>File_storage
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/other_services/" title="Other services" class="dd-item
        
        
        
        ">
      <a href="/other_services/">
          <b>7. </b>Other services
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/other_services/audit/" title="Audit services" class="dd-item
        
        
        
        ">
      <a href="/other_services/audit/">
          Audit services
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li>
                  <a class="padding" href="https://github.com/creatorflow-io/Juice"><i class='fab fa-github'></i> Github repo</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                  
                  
                  
                  <div id="top-github-link">
                    <a class="github-link" title='Edit this page' href="https://github.com/creatorflow-io/juice-docs/tree/master/content/core/eventbus/_index.md" target="blank">
                      <i class="fas fa-code-branch"></i>
                      <span id="top-github-link-text">Edit this page</span>
                    </a>
                  </div>
                  
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'></a> > <a href='/core/'>Core features</a> > Event bus
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#rabbitmq-broker">RabbitMQ broker</a></li>
        <li><a href="#integrationevent">IntegrationEvent</a></li>
        <li><a href="#integrationeventhandler">IntegrationEventHandler</a></li>
        <li><a href="#integrationeventlog">IntegrationEventLog</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Event bus
            </h1>
          

        



	<p>To communicate between services we defined an <strong>IEventBus</strong> interface with a built-in RabbitMQ broker.
Please follow up <a href="https://learn.microsoft.com/en-us/dotnet/architecture/microservices/multi-container-microservice-net-applications/integration-event-based-microservice-communications">Implementing event-based communication between microservices</a> for details.</p>
<pre tabindex="0"><code>namespace Juice.EventBus
{
    /// &lt;summary&gt;
    /// Event bus
    /// &lt;/summary&gt;
    public interface IEventBus
    {
        /// &lt;summary&gt;
        /// Publish &lt;see cref=&#34;IntegrationEvent&#34;/&gt; to implemented broker like RabbitMQ, ServiceBus...
        /// &lt;/summary&gt;
        /// &lt;param name=&#34;event&#34;&gt;&lt;/param&gt;
        Task PublishAsync(IntegrationEvent @event);

        /// &lt;summary&gt;
        /// Subscribe an &lt;see cref=&#34;IntegrationEvent&#34;/&gt; with specified &lt;see cref=&#34;IIntegrationEventHandler{T}&#34;/&gt;
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name=&#34;TH&#34;&gt;&lt;/typeparam&gt;
        void Subscribe&lt;T, TH&gt;(string? key = default)
            where T : IntegrationEvent
            where TH : IIntegrationEventHandler&lt;T&gt;;

        /// &lt;summary&gt;
        /// Subscribe an &lt;see cref=&#34;IntegrationEvent&#34;/&gt; with specified &lt;see cref=&#34;IIntegrationEventHandler{T}&#34;/&gt;
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name=&#34;TH&#34;&gt;&lt;/typeparam&gt;
        void Unsubscribe&lt;T, TH&gt;(string? key = default)
            where TH : IIntegrationEventHandler&lt;T&gt;
            where T : IntegrationEvent;
    }
}
</code></pre><h3 id="rabbitmq-broker">RabbitMQ broker</h3>
<p>To use RabbitMQ broker as an event bus backend, we register RabbitMQEventBus services via <em>IServiceCollection extension</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    ...
</span></span><span style="display:flex; background-color:#3c3d38"><span>    <span style="color:#66d9ef">using</span> Juice.EventBus.RabbitMQ.DependencyInjection
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex; background-color:#3c3d38"><span>    services.RegisterRabbitMQEventBus(configuration.GetSection(<span style="color:#e6db74">&#34;RabbitMQ&#34;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// OR</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// services.RegisterRabbitMQEventBus(configuration.GetSection(&#34;RabbitMQ&#34;), options=&gt; {</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// configure options here</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// });</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// RabbitMQ options</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// &#34;RabbitMQ&#34;: {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//      &#34;RabbitMQEnabled&#34;: false,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//      &#34;SubscriptionClientName&#34;: &#34;xunit_test&#34;, // client name must unique for a service (not service instance)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//      &#34;RetryCount&#34;: 5,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//      &#34;Connection&#34;: &#34;your_rabbitmq_host&#34;,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//      &#34;Port&#34;: 5672,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//      &#34;VirtualHost&#34;: null,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//      &#34;UserName&#34;: null,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//      &#34;Password&#34;: null</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// }</span>
</span></span></code></pre></div><p>The library can be accessed via Nuget:</p>
<ul>
<li><a href="https://www.nuget.org/packages/Juice.EventBus.RabbitMQ">Juice.EventBus.RabbitMQ</a></li>
</ul>
<h3 id="integrationevent">IntegrationEvent</h3>
<p>You can define your integration event that inherit <strong>IntegrationEvent</strong> record then publish throw <strong>IEventBus</strong></p>
<pre tabindex="0"><code>    using Juice.EventBus;
    public record ContentPublishedIntegrationEvent : IntegrationEvent
    {
        public ContentPublishedIntegrationEvent(string message)
        {
            Message = message;
        }
        public string Message { get; set; }
    }
</code></pre><pre tabindex="0"><code>    ...
    using Juice.EventBus;
    ...

    await eventBus.PublishAsync(new ContentPublishedIntegrationEvent($&#34;Hello&#34;));
</code></pre><p>The library can be accessed via Nuget:</p>
<ul>
<li><a href="https://www.nuget.org/packages/Juice.EventBus">Juice.EventBus</a></li>
</ul>
<h3 id="integrationeventhandler">IntegrationEventHandler</h3>
<p>Someone will implement an integration handler from <strong>IIntegrationEventHandler<!-- raw HTML omitted --></strong> interface in other app to handle your integration event for their purposes.</p>
<p>For example: a handler that print received message and event time.</p>
<pre tabindex="0"><code>    ...
    using Juice.EventBus;
    ...

    public class ContentPublishedIntegrationEventHandler : IIntegrationEventHandler&lt;ContentPublishedIntegrationEvent&gt;
    {
        private ILogger _logger;
        public ContentPublishedIntegrationEventHandler(ILogger&lt;ContentPublishedIntegrationEventHandler&gt; logger)
        {
            _logger = logger;
        }
        public async Task HandleAsync(ContentPublishedIntegrationEvent @event)
        {
            await Task.Yield();
            _logger.LogInformation(&#34;[X] Received {0} at {1}&#34;, @event.Message, @event.CreationDate);
        }
    }
</code></pre><p>Then register into DI and subscribe event</p>
<pre tabindex="0"><code>    // configure services
    services.AddTransient&lt;ContentPublishedIntegrationEventHandler&gt;();

    ...
    // configure WebApplication 
    var eventBus = app.Services.GetRequiredService&lt;IEventBus&gt;();

    eventBus.Subscribe&lt;ContentPublishedIntegrationEvent, ContentPublishedIntegrationEventHandler&gt;();
</code></pre><p>The library can be accessed via Nuget:</p>
<ul>
<li><a href="https://www.nuget.org/packages/Juice.EventBus">Juice.EventBus</a></li>
</ul>
<h3 id="integrationeventlog">IntegrationEventLog</h3>
<p>It is a part of balanced approach for atomicity and resiliency when publishing to the event bus.
You can follow <a href="https://learn.microsoft.com/en-us/dotnet/architecture/microservices/multi-container-microservice-net-applications/subscribe-events#designing-atomicity-and-resiliency-when-publishing-to-the-event-bus">Designing atomicity and resiliency when publishing to the event bus</a> topic for more information.
We provide <strong>IIntegrationEventLogService</strong> interface with an implementation for EF backend use SQLServer or PostgreSQL.</p>
<pre tabindex="0"><code>    public interface IIntegrationEventLogService : IDisposable
    {
        IntegrationEventLogContext LogContext { get; }
        
        // Use to process pending events
        Task&lt;IEnumerable&lt;IntegrationEventLogEntry&gt;&gt; RetrieveEventLogsPendingToPublishAsync(Guid transactionId);

        // Save an integration event within a same transaction with domain DBContext
        Task SaveEventAsync(IntegrationEvent @event, IDbContextTransaction transaction);

        // Change event state after publish it to the service bus
        Task MarkEventAsPublishedAsync(Guid eventId);

        // Change event state before publish it to the service bus
        Task MarkEventAsInProgressAsync(Guid eventId);

        // Change event state on failure publising
        Task MarkEventAsFailedAsync(Guid eventId);

    }

    public interface IIntegrationEventLogService&lt;out TContext&gt; : IIntegrationEventLogService
        where TContext : DbContext
    {
        /// &lt;summary&gt;
        /// Ensure event log context has an associated connection with input &lt;see cref=&#34;T&#34;/&gt; context.
        /// &lt;para&gt;Throw &lt;see cref=&#34;ArgumentException&#34;/&gt; if input context has not same type with &lt;see cref=&#34;TContext&#34;/&gt;&lt;/para&gt;
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&#34;context&#34;&gt;&lt;/param&gt;
        void EnsureAssociatedConnection&lt;T&gt;(T context) where T : DbContext;
    }
</code></pre><p>We need to register services and a <strong>DomainDbContext</strong> to use this feature.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    ...
</span></span><span style="display:flex; background-color:#3c3d38"><span>    <span style="color:#66d9ef">using</span> Juice.EventBus.IntegrationEventLog.EF;
</span></span><span style="display:flex; background-color:#3c3d38"><span>    <span style="color:#66d9ef">using</span> Juice.EventBus.IntegrationEventLog.EF.DependencyInjection;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>    services.AddIntegrationEventLog() <span style="color:#75715e">// add integration event log services</span>
</span></span><span style="display:flex;"><span>        .RegisterContext&lt;DomainDbContext&gt;(schema); 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// migrate DB if need</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>    
</span></span></code></pre></div><p>Call <code>.RegisterContext&lt;DomainDbContext&gt;(schema)</code> will register an <strong>IntegrationEventLogContext</strong> factory that mapped to specified schema and work with DomainDbContext. So <strong>IIntegrationEventLogService</strong> service can get <code>Func&lt;DomainDbContext, IntegrationEventLogContext&gt;</code> as a service and create an <strong>IntegrationEventLogContext</strong> instance from a <strong>DomainDbContext</strong> instance.</p>
<p>They will have associated DbConnection and can access the same transaction.</p>
<p>Step by step, the process goes like this:</p>
<ol>
<li>
<p>The application begins a local database transaction.</p>
</li>
<li>
<p>It then updates the state of your domain entities and inserts an event into the integration event table.</p>
</li>
<li>
<p>Finally, it commits the transaction, so you get the desired atomicity and then</p>
</li>
<li>
<p>You publish the event somehow (next).</p>
</li>
</ol>
<p>When implementing the steps of publishing the events, you have these choices:</p>
<ul>
<li>
<p>Publish the integration event right after committing the transaction and use another local transaction to mark the events in the table as being published. Then, use the table just as an artifact to track the integration events in case of issues in the remote microservices, and perform compensatory actions based on the stored integration events.</p>
</li>
<li>
<p>Use the table as a kind of queue. A separate application thread or process queries the integration event table, publishes the events to the event bus, and then uses a local transaction to mark the events as published.</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    ...
</span></span><span style="display:flex; background-color:#3c3d38"><span>    <span style="color:#66d9ef">using</span> Juice.EventBus;
</span></span><span style="display:flex; background-color:#3c3d38"><span>    <span style="color:#66d9ef">using</span> Juice.EventBus.IntegrationEventLog.EF;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> context = scope.ServiceProvider.GetRequiredService&lt;DomainDbContext&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> eventLogService = scope.ServiceProvider.GetRequiredService&lt;IIntegrationEventLogService&lt;DomainDbContext&gt;&gt;();
</span></span><span style="display:flex;"><span>    eventLogService.EnsureAssociatedConnection(context);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// do something with your DomainDbContext</span>
</span></span><span style="display:flex;"><span>    context.Add(<span style="color:#66d9ef">new</span> Content());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// create an integration event</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> evt = <span style="color:#66d9ef">new</span> ContentPublishedIntegrationEvent(<span style="color:#e6db74">$&#34;Content {content.Code} was published.&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// save DomainDbContext changes and add an integration event at the same time, in the same transaction</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> ResilientTransaction.New(context).ExecuteAsync(<span style="color:#66d9ef">async</span> (transaction) =&gt;
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Achieving atomicity between original catalog database operation and the IntegrationEventLog thanks to a local transaction</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> context.SaveChangesAsync();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> eventLogService.SaveEventAsync(evt, transaction);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// if everything is ok then you can publish created integration event throw service bus</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> eventBus = scope.ServiceProvider.GetRequiredService&lt;IEventBus&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        logger.LogInformation(<span style="color:#e6db74">&#34;----- Publishing integration event: {IntegrationEventId_published} from {AppName} - ({@IntegrationEvent})&#34;</span>, evt.Id, nameof(IntegrationEventLogTest), evt);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> eventLogService.MarkEventAsInProgressAsync(evt.Id);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> eventBus.PublishAsync(evt);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> eventLogService.MarkEventAsPublishedAsync(evt.Id);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        logger.LogError(ex, <span style="color:#e6db74">&#34;ERROR Publishing integration event: {IntegrationEventId} from {AppName} - ({@IntegrationEvent})&#34;</span>, evt.Id, nameof(IntegrationEventLogTest), evt);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> eventLogService.MarkEventAsFailedAsync(evt.Id);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>The library can be accessed via Nuget:</p>
<ul>
<li><a href="https://www.nuget.org/packages/Juice.EventBus.IntegrationEventLog.EF">Juice.EventBus.IntegrationEventLog.EF</a></li>
<li><a href="https://www.nuget.org/packages/Juice.EventBus.IntegrationEventLog.EF.SqlServer">Juice.EventBus.IntegrationEventLog.EF.SqlServer</a></li>
<li><a href="https://www.nuget.org/packages/Juice.EventBus.IntegrationEventLog.EF.PostgreSQL">Juice.EventBus.IntegrationEventLog.EF.PostgreSQL</a></li>
</ul>





<footer class=" footline" >
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="/core/mediator/" title="Mediator"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/core/entityframework/" title="Entity framework" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1694751655"></script>
    <script src="/js/perfect-scrollbar.min.js?1694751655"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1694751655"></script>
    <script src="/js/jquery.sticky.js?1694751655"></script>
    <script src="/js/featherlight.min.js?1694751655"></script>
    <script src="/js/highlight.pack.js?1694751655"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1694751655"></script>
    <script src="/js/learn.js?1694751655"></script>
    <script src="/js/hugo-learn.js?1694751655"></script>
    
        
            <script src="/mermaid/mermaid.js?1694751655"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>

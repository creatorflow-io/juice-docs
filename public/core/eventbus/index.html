<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article" data-r-output-format="html">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.144.0">
    <meta name="generator" content="Relearn 7.6.1+4407b4364ab6f7477f7671fbd20c0494bade40ee">
    <meta name="description" content="To communicate between services we defined an IEventBus interface with a built-in RabbitMQ broker. Please follow up Implementing event-based communication between microservices for details.
namespace Juice.EventBus { /// &lt;summary&gt; /// Event bus /// &lt;/summary&gt; public interface IEventBus { /// &lt;summary&gt; /// Publish &lt;see cref=&#34;IntegrationEvent&#34;/&gt; to implemented broker like RabbitMQ, ServiceBus... /// &lt;/summary&gt; /// &lt;param name=&#34;event&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;tenantId&#34;&gt;&lt;/param&gt; Task PublishAsync(IntegrationEvent @event, string? tenantId = default); /// &lt;summary&gt; /// Subscribe an &lt;see cref=&#34;IntegrationEvent&#34;/&gt; with specified &lt;see cref=&#34;IIntegrationEventHandler{T}&#34;/&gt; /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;typeparam name=&#34;TH&#34;&gt;&lt;/typeparam&gt; void Subscribe&lt;T, TH&gt;(string? key = default) where T : IntegrationEvent where TH : IIntegrationEventHandler&lt;T&gt;; /// &lt;summary&gt; /// Subscribe an &lt;see cref=&#34;IntegrationEvent&#34;/&gt; with specified &lt;see cref=&#34;IIntegrationEventHandler{T}&#34;/&gt; /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;typeparam name=&#34;TH&#34;&gt;&lt;/typeparam&gt; void Unsubscribe&lt;T, TH&gt;(string? key = default) where TH : IIntegrationEventHandler&lt;T&gt; where T : IntegrationEvent; } }RabbitMQ broker To use RabbitMQ broker as an event bus backend, we register RabbitMQEventBus services via IServiceCollection extension">
    <meta name="author" content="">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Event bus :: Juice&#39;s documentation">
    <meta name="twitter:description" content="To communicate between services we defined an IEventBus interface with a built-in RabbitMQ broker. Please follow up Implementing event-based communication between microservices for details.
namespace Juice.EventBus { /// &lt;summary&gt; /// Event bus /// &lt;/summary&gt; public interface IEventBus { /// &lt;summary&gt; /// Publish &lt;see cref=&#34;IntegrationEvent&#34;/&gt; to implemented broker like RabbitMQ, ServiceBus... /// &lt;/summary&gt; /// &lt;param name=&#34;event&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;tenantId&#34;&gt;&lt;/param&gt; Task PublishAsync(IntegrationEvent @event, string? tenantId = default); /// &lt;summary&gt; /// Subscribe an &lt;see cref=&#34;IntegrationEvent&#34;/&gt; with specified &lt;see cref=&#34;IIntegrationEventHandler{T}&#34;/&gt; /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;typeparam name=&#34;TH&#34;&gt;&lt;/typeparam&gt; void Subscribe&lt;T, TH&gt;(string? key = default) where T : IntegrationEvent where TH : IIntegrationEventHandler&lt;T&gt;; /// &lt;summary&gt; /// Subscribe an &lt;see cref=&#34;IntegrationEvent&#34;/&gt; with specified &lt;see cref=&#34;IIntegrationEventHandler{T}&#34;/&gt; /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;typeparam name=&#34;TH&#34;&gt;&lt;/typeparam&gt; void Unsubscribe&lt;T, TH&gt;(string? key = default) where TH : IIntegrationEventHandler&lt;T&gt; where T : IntegrationEvent; } }RabbitMQ broker To use RabbitMQ broker as an event bus backend, we register RabbitMQEventBus services via IServiceCollection extension">
    <meta property="og:url" content="http://example.org/core/eventbus/index.html">
    <meta property="og:site_name" content="Juice&#39;s documentation">
    <meta property="og:title" content="Event bus :: Juice&#39;s documentation">
    <meta property="og:description" content="To communicate between services we defined an IEventBus interface with a built-in RabbitMQ broker. Please follow up Implementing event-based communication between microservices for details.
namespace Juice.EventBus { /// &lt;summary&gt; /// Event bus /// &lt;/summary&gt; public interface IEventBus { /// &lt;summary&gt; /// Publish &lt;see cref=&#34;IntegrationEvent&#34;/&gt; to implemented broker like RabbitMQ, ServiceBus... /// &lt;/summary&gt; /// &lt;param name=&#34;event&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;tenantId&#34;&gt;&lt;/param&gt; Task PublishAsync(IntegrationEvent @event, string? tenantId = default); /// &lt;summary&gt; /// Subscribe an &lt;see cref=&#34;IntegrationEvent&#34;/&gt; with specified &lt;see cref=&#34;IIntegrationEventHandler{T}&#34;/&gt; /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;typeparam name=&#34;TH&#34;&gt;&lt;/typeparam&gt; void Subscribe&lt;T, TH&gt;(string? key = default) where T : IntegrationEvent where TH : IIntegrationEventHandler&lt;T&gt;; /// &lt;summary&gt; /// Subscribe an &lt;see cref=&#34;IntegrationEvent&#34;/&gt; with specified &lt;see cref=&#34;IIntegrationEventHandler{T}&#34;/&gt; /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;typeparam name=&#34;TH&#34;&gt;&lt;/typeparam&gt; void Unsubscribe&lt;T, TH&gt;(string? key = default) where TH : IIntegrationEventHandler&lt;T&gt; where T : IntegrationEvent; } }RabbitMQ broker To use RabbitMQ broker as an event bus backend, we register RabbitMQEventBus services via IServiceCollection extension">
    <meta property="og:locale" content="en_us">
    <meta property="og:type" content="website">
    <meta itemprop="name" content="Event bus :: Juice&#39;s documentation">
    <meta itemprop="description" content="To communicate between services we defined an IEventBus interface with a built-in RabbitMQ broker. Please follow up Implementing event-based communication between microservices for details.
namespace Juice.EventBus { /// &lt;summary&gt; /// Event bus /// &lt;/summary&gt; public interface IEventBus { /// &lt;summary&gt; /// Publish &lt;see cref=&#34;IntegrationEvent&#34;/&gt; to implemented broker like RabbitMQ, ServiceBus... /// &lt;/summary&gt; /// &lt;param name=&#34;event&#34;&gt;&lt;/param&gt; /// &lt;param name=&#34;tenantId&#34;&gt;&lt;/param&gt; Task PublishAsync(IntegrationEvent @event, string? tenantId = default); /// &lt;summary&gt; /// Subscribe an &lt;see cref=&#34;IntegrationEvent&#34;/&gt; with specified &lt;see cref=&#34;IIntegrationEventHandler{T}&#34;/&gt; /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;typeparam name=&#34;TH&#34;&gt;&lt;/typeparam&gt; void Subscribe&lt;T, TH&gt;(string? key = default) where T : IntegrationEvent where TH : IIntegrationEventHandler&lt;T&gt;; /// &lt;summary&gt; /// Subscribe an &lt;see cref=&#34;IntegrationEvent&#34;/&gt; with specified &lt;see cref=&#34;IIntegrationEventHandler{T}&#34;/&gt; /// &lt;/summary&gt; /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt; /// &lt;typeparam name=&#34;TH&#34;&gt;&lt;/typeparam&gt; void Unsubscribe&lt;T, TH&gt;(string? key = default) where TH : IIntegrationEventHandler&lt;T&gt; where T : IntegrationEvent; } }RabbitMQ broker To use RabbitMQ broker as an event bus backend, we register RabbitMQEventBus services via IServiceCollection extension">
    <meta itemprop="datePublished" content="2023-04-03T20:23:59+07:00">
    <meta itemprop="dateModified" content="2023-04-03T20:23:59+07:00">
    <meta itemprop="wordCount" content="1032">
    <title>Event bus :: Juice&#39;s documentation</title>
    <link href="/core/eventbus/index.xml" rel="alternate" type="application/rss+xml" title="Event bus :: Juice&#39;s documentation">
    <link href="/images/favicon.png?1750824110" rel="icon" type="image/png">
    <link href="/images/favicon.ico?1750824110" rel="icon" type="image/x-icon" sizes="any">
    <link href="/fonts/fontawesome/css/fontawesome-all.min.css?1750824110" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/fonts/fontawesome/css/fontawesome-all.min.css?1750824110" rel="stylesheet"></noscript>
    <link href="/css/perfect-scrollbar/perfect-scrollbar.min.css?1750824110" rel="stylesheet">
    <link href="/css/theme.min.css?1750824110" rel="stylesheet">
    <link href="/css/format-html.min.css?1750824110" rel="stylesheet" id="R-format-style">
    <link href="/css/auto-complete/auto-complete.min.css?1750824110" rel="stylesheet">
    <script src="/js/auto-complete/auto-complete.min.js?1750824110" defer></script>
    <script src="/js/lunr/lunr.min.js?1750824110" defer></script>
    <script src="/js/lunr/lunr.stemmer.support.min.js?1750824110" defer></script>
    <script src="/js/lunr/lunr.multi.min.js?1750824110" defer></script>
    <script src="/js/lunr/lunr.en.min.js?1750824110" defer></script>
    <script src="/js/search.min.js?1750824110" defer></script>
    <script>
      window.relearn = window.relearn || {};
      // configuration
      window.relearn.min = `.min`;
      window.relearn.path='\/core\/eventbus\/index.html';
      window.relearn.relBasePath='..\/..';
      window.relearn.relBaseUri='..\/..';
      window.relearn.absBaseUri='http:\/\/example.org';
      window.relearn.contentLangs=['en'];
      window.relearn.index_js_url="/searchindex.en.js?1750824110";
      window.relearn.disableAnchorCopy=false;
      window.relearn.disableAnchorScrolling=false;
      window.relearn.disableInlineCopyToClipboard=false;
      window.relearn.enableBlockCodeWrap=true;
      // legal
      window.relearn.getItem = (s,n) => {return s.getItem(n)};
      window.relearn.setItem = (s,n,v) => {return s.setItem(n,v)};
      window.relearn.removeItem = (s,n) => {return s.removeItem(n)};
      // variant stuff
      window.relearn.themevariants = [ 'mine' ];
      window.relearn.customvariantname = "my-custom-variant";
      window.relearn.changeVariant = function(variant) {
        var oldVariant = document.documentElement.dataset.rThemeVariant;
        window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        document.documentElement.dataset.rThemeVariant = variant;
        if (oldVariant != variant) {
          document.dispatchEvent( new CustomEvent('themeVariantLoaded', { detail: { variant, oldVariant } }) );
          window.relearn.markVariant();
        }
      }
      window.relearn.markVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant");
        document.querySelectorAll(".R-variantswitcher select").forEach((select) => {select.value = variant;});
      }
      window.relearn.initVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant") ?? "";
        if( variant == window.relearn.customvariantname ){
        }else if( !variant || !window.relearn.themevariants.includes(variant) ){
          variant = window.relearn.themevariants[0];
          window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        }
        document.documentElement.dataset.rThemeVariant = variant;
      }
      window.relearn.initVariant();
      window.relearn.markVariant();
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
    </script>
  </head>
  <body class="mobile-support html" data-url="/core/eventbus/index.html">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide"><button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button>
            </div>
            <div class="topbar-button topbar-button-toc" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleTopbarFlyout(this)" type="button" title="Table of Contents (CTRL&#43;ALT&#43;t)"><i class="fa-fw fas fa-list-alt"></i></button>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
<nav class="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#rabbitmq-broker">RabbitMQ broker</a></li>
        <li><a href="#implementation">Implementation</a></li>
        <li><a href="#integrationeventlog">IntegrationEventLog</a></li>
        <li><a href="#eventbuswrapper">EventBusWrapper</a></li>
      </ul>
    </li>
  </ul>
</nav>
                </div>
              </div>
            </div>
          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList">
            <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/index.html"><span itemprop="name">Juice&#39;s documentation</span></a><meta itemprop="position" content="1">&nbsp;>&nbsp;</li>
            <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/core/index.html"><span itemprop="name">Core features</span></a><meta itemprop="position" content="2">&nbsp;>&nbsp;</li>
            <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><span itemprop="name">Event bus</span><meta itemprop="position" content="3"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-edit" data-content-empty="disable" data-width-s="area-more" data-width-m="show" data-width-l="show"><a class="topbar-control" href="https://github.com/creatorflow-io/juice-docs/tree/master/content/core/eventbus/_index.md" rel="external" target="_blank" title="Edit (CTRL+ALT+w)"><i class="fa-fw fas fa-pen"></i></a>
            </div>
            <div class="topbar-button topbar-button-prev" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/core/mediator/index.html" title="Mediator (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a>
            </div>
            <div class="topbar-button topbar-button-next" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/core/eventbus/breaking/index.html" title="Breaking changes (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a>
            </div>
            <div class="topbar-button topbar-button-more" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleTopbarFlyout(this)" type="button" title="More"><i class="fa-fw fas fa-ellipsis-v"></i></button>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
                  <div class="topbar-area topbar-area-more" data-area="more">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable core" tabindex="-1">
        <div class="flex-block-wrapper">
<article class="default">
  <header class="headline">
  </header>

<h1 id="event-bus">Event bus</h1>

<p>To communicate between services we defined an <strong>IEventBus</strong> interface with a built-in RabbitMQ broker.
Please follow up <a href="https://learn.microsoft.com/en-us/dotnet/architecture/microservices/multi-container-microservice-net-applications/integration-event-based-microservice-communications" rel="external" target="_blank">Implementing event-based communication between microservices</a> for details.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>namespace Juice.EventBus
{
    /// &lt;summary&gt;
    /// Event bus
    /// &lt;/summary&gt;
    public interface IEventBus
    {
        /// &lt;summary&gt;
        /// Publish &lt;see cref=&#34;IntegrationEvent&#34;/&gt; to implemented broker like RabbitMQ, ServiceBus...
        /// &lt;/summary&gt;
        /// &lt;param name=&#34;event&#34;&gt;&lt;/param&gt;
        /// &lt;param name=&#34;tenantId&#34;&gt;&lt;/param&gt;
        Task PublishAsync(IntegrationEvent @event, string? tenantId = default);

        /// &lt;summary&gt;
        /// Subscribe an &lt;see cref=&#34;IntegrationEvent&#34;/&gt; with specified &lt;see cref=&#34;IIntegrationEventHandler{T}&#34;/&gt;
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name=&#34;TH&#34;&gt;&lt;/typeparam&gt;
        void Subscribe&lt;T, TH&gt;(string? key = default)
            where T : IntegrationEvent
            where TH : IIntegrationEventHandler&lt;T&gt;;

        /// &lt;summary&gt;
        /// Subscribe an &lt;see cref=&#34;IntegrationEvent&#34;/&gt; with specified &lt;see cref=&#34;IIntegrationEventHandler{T}&#34;/&gt;
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name=&#34;TH&#34;&gt;&lt;/typeparam&gt;
        void Unsubscribe&lt;T, TH&gt;(string? key = default)
            where TH : IIntegrationEventHandler&lt;T&gt;
            where T : IntegrationEvent;
    }
}</code></pre></div>
<h3 id="rabbitmq-broker">RabbitMQ broker</h3>
<p>To use RabbitMQ broker as an event bus backend, we register RabbitMQEventBus services via <em>IServiceCollection extension</em></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    ...
</span></span><span style="display:flex; background-color:#3c3d38"><span>    <span style="color:#66d9ef">using</span> Juice.EventBus.RabbitMQ.DependencyInjection
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex; background-color:#3c3d38"><span>    <span style="color:#75715e">// Register IEventBus service</span>
</span></span><span style="display:flex;"><span>    services.RegisterRabbitMQEventBus(configuration.GetSection(<span style="color:#e6db74">&#34;RabbitMQ&#34;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// OR</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Register strongly typed service</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// services.RegisterRabbitMQEventBus&lt;Typed&gt;(configuration.GetSection(&#34;RabbitMQ&#34;));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// OR</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// services.RegisterRabbitMQEventBus(configuration.GetSection(&#34;RabbitMQ&#34;), options=&gt; {</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// configure options here</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// });</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// RabbitMQ options</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// &#34;RabbitMQ&#34;: {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//      &#34;RabbitMQEnabled&#34;: false,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//      &#34;SubscriptionClientName&#34;: &#34;xunit_test&#34;, // client name must unique for a service (not service instance)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//      &#34;RetryCount&#34;: 5,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//      &#34;Connection&#34;: &#34;your_rabbitmq_host&#34;,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//      &#34;Port&#34;: 5672,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//      &#34;VirtualHost&#34;: null,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//      &#34;UserName&#34;: null,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//      &#34;Password&#34;: null,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//      &#34;ExchangeType: null,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//      &#34;QueueType&#34;: null,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//      &#34;AckOnProcessed&#34;: null</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// }</span></span></span></code></pre></div>
<p>The library can be accessed via Nuget:</p>
<ul>
<li><a href="https://www.nuget.org/packages/Juice.EventBus.RabbitMQ" rel="external" target="_blank">Juice.EventBus.RabbitMQ</a></li>
</ul>
<h3 id="implementation">Implementation</h3>
<h4 id="integrationevent">IntegrationEvent</h4>
<p>You can define your integration event that inherit <strong>IntegrationEvent</strong> record then publish throw <strong>IEventBus</strong></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    using Juice.EventBus;
    public record ContentPublishedIntegrationEvent : IntegrationEvent
    {
        public ContentPublishedIntegrationEvent(string message)
        {
            Message = message;
        }
        public string Message { get; set; }
    }</code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    ...
    using Juice.EventBus;
    ...

    await eventBus.PublishAsync(new ContentPublishedIntegrationEvent($&#34;Hello&#34;));</code></pre></div>
<p>The library can be accessed via Nuget:</p>
<ul>
<li><a href="https://www.nuget.org/packages/Juice.EventBus" rel="external" target="_blank">Juice.EventBus</a></li>
</ul>
<h4 id="integrationeventhandler">IntegrationEventHandler</h4>
<p>Someone will implement an integration handler from <strong>IIntegrationEventHandler<!-- raw HTML omitted --></strong> interface in other app to handle your integration event for their purposes.</p>
<p>For example: a handler that print received message and event time.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    ...
    using Juice.EventBus;
    ...

    public class ContentPublishedIntegrationEventHandler : IIntegrationEventHandler&lt;ContentPublishedIntegrationEvent&gt;
    {
        private ILogger _logger;
        public ContentPublishedIntegrationEventHandler(ILogger&lt;ContentPublishedIntegrationEventHandler&gt; logger)
        {
            _logger = logger;
        }
        public async Task HandleAsync(ContentPublishedIntegrationEvent @event)
        {
            await Task.Yield();
            _logger.LogInformation(&#34;[X] Received {0} at {1}&#34;, @event.Message, @event.CreationDate);
        }
    }</code></pre></div>
<p>Then register into DI and subscribe event</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    // configure services
    services.AddTransient&lt;ContentPublishedIntegrationEventHandler&gt;();

    ...
    // configure WebApplication 
    var eventBus = app.Services.GetRequiredService&lt;IEventBus&gt;();

    eventBus.Subscribe&lt;ContentPublishedIntegrationEvent, ContentPublishedIntegrationEventHandler&gt;();</code></pre></div>
<p>The library can be accessed via Nuget:</p>
<ul>
<li><a href="https://www.nuget.org/packages/Juice.EventBus" rel="external" target="_blank">Juice.EventBus</a></li>
</ul>
<h3 id="integrationeventlog">IntegrationEventLog</h3>
<p>It is a part of balanced approach for atomicity and resiliency when publishing to the event bus.
You can follow <a href="https://learn.microsoft.com/en-us/dotnet/architecture/microservices/multi-container-microservice-net-applications/subscribe-events#designing-atomicity-and-resiliency-when-publishing-to-the-event-bus" rel="external" target="_blank">Designing atomicity and resiliency when publishing to the event bus</a> topic for more information.
We provide <strong>IIntegrationEventLogService</strong> interface with an implementation for EF backend use SQLServer or PostgreSQL.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>    public interface IIntegrationEventLogService : IDisposable
    {
        IntegrationEventLogContext LogContext { get; }
        
        // Use to process pending events
        Task&lt;IEnumerable&lt;IntegrationEventLogEntry&gt;&gt; RetrieveEventLogsPendingToPublishAsync(Guid transactionId);

        // Save an integration event within a same transaction with domain DBContext
        Task SaveEventAsync(IntegrationEvent @event, IDbContextTransaction transaction);

        // Change event state after publish it to the service bus
        Task MarkEventAsPublishedAsync(Guid eventId);

        // Change event state before publish it to the service bus
        Task MarkEventAsInProgressAsync(Guid eventId);

        // Change event state on failure publising
        Task MarkEventAsFailedAsync(Guid eventId);

    }

    public interface IIntegrationEventLogService&lt;out TContext&gt; : IIntegrationEventLogService
        where TContext : DbContext
    {
        /// &lt;summary&gt;
        /// Ensure event log context has an associated connection with input &lt;see cref=&#34;T&#34;/&gt; context.
        /// &lt;para&gt;Throw &lt;see cref=&#34;ArgumentException&#34;/&gt; if input context has not same type with &lt;see cref=&#34;TContext&#34;/&gt;&lt;/para&gt;
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&#34;T&#34;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&#34;context&#34;&gt;&lt;/param&gt;
        void EnsureAssociatedConnection&lt;T&gt;(T context) where T : DbContext;
    }</code></pre></div>
<h4 id="usage">Usage</h4>
<p>We need to register services and a <strong>DomainDbContext</strong> to use this feature.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    ...
</span></span><span style="display:flex; background-color:#3c3d38"><span>    <span style="color:#66d9ef">using</span> Juice.EventBus.IntegrationEventLog.EF;
</span></span><span style="display:flex; background-color:#3c3d38"><span>    <span style="color:#66d9ef">using</span> Juice.EventBus.IntegrationEventLog.EF.DependencyInjection;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>    services.AddIntegrationEventLog() <span style="color:#75715e">// add integration event log services</span>
</span></span><span style="display:flex;"><span>        .RegisterContext&lt;DomainDbContext&gt;(schema); 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// migrate DB if need</span>
</span></span><span style="display:flex; background-color:#3c3d38"><span>    </span></span></code></pre></div>
<p>Call <code>.RegisterContext&lt;DomainDbContext&gt;(schema)</code> will register an <strong>IntegrationEventLogContext</strong> factory that mapped to specified schema and work with DomainDbContext. So <strong>IIntegrationEventLogService</strong> service can get <code>Func&lt;DomainDbContext, IntegrationEventLogContext&gt;</code> as a service and create an <strong>IntegrationEventLogContext</strong> instance from a <strong>DomainDbContext</strong> instance.</p>
<p>They will have associated DbConnection and can access the same transaction.</p>
<h4 id="working-process">Working process</h4>
<p>Step by step, the process goes like this:</p>
<ol>
<li>
<p>The application begins a local database transaction.</p>
</li>
<li>
<p>It then updates the state of your domain entities and inserts an event into the integration event table.</p>
</li>
<li>
<p>Finally, it commits the transaction, so you get the desired atomicity and then</p>
</li>
<li>
<p>You publish the event somehow (next).</p>
</li>
</ol>
<p>When implementing the steps of publishing the events, you have these choices:</p>
<ul>
<li>
<p>Publish the integration event right after committing the transaction and use another local transaction to mark the events in the table as being published. Then, use the table just as an artifact to track the integration events in case of issues in the remote microservices, and perform compensatory actions based on the stored integration events.</p>
</li>
<li>
<p>Use the table as a kind of queue. A separate application thread or process queries the integration event table, publishes the events to the event bus, and then uses a local transaction to mark the events as published.</p>
</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    ...
</span></span><span style="display:flex; background-color:#3c3d38"><span>    <span style="color:#66d9ef">using</span> Juice.EventBus;
</span></span><span style="display:flex; background-color:#3c3d38"><span>    <span style="color:#66d9ef">using</span> Juice.EventBus.IntegrationEventLog.EF;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> context = scope.ServiceProvider.GetRequiredService&lt;DomainDbContext&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> eventLogService = scope.ServiceProvider.GetRequiredService&lt;IIntegrationEventLogService&lt;DomainDbContext&gt;&gt;();
</span></span><span style="display:flex;"><span>    eventLogService.EnsureAssociatedConnection(context);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// do something with your DomainDbContext</span>
</span></span><span style="display:flex;"><span>    context.Add(<span style="color:#66d9ef">new</span> Content());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// create an integration event</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> evt = <span style="color:#66d9ef">new</span> ContentPublishedIntegrationEvent(<span style="color:#e6db74">$&#34;Content {content.Code} was published.&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// save DomainDbContext changes and add an integration event at the same time, in the same transaction</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> ResilientTransaction.New(context).ExecuteAsync(<span style="color:#66d9ef">async</span> (transaction) =&gt;
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Achieving atomicity between original catalog database operation and the IntegrationEventLog thanks to a local transaction</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> context.SaveChangesAsync();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> eventLogService.SaveEventAsync(evt, transaction);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// if everything is ok then you can publish created integration event throw service bus</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> eventBus = scope.ServiceProvider.GetRequiredService&lt;IEventBus&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        logger.LogInformation(<span style="color:#e6db74">&#34;----- Publishing integration event: {IntegrationEventId_published} from {AppName} - ({@IntegrationEvent})&#34;</span>, evt.Id, nameof(IntegrationEventLogTest), evt);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> eventLogService.MarkEventAsInProgressAsync(evt.Id);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> eventBus.PublishAsync(evt);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> eventLogService.MarkEventAsPublishedAsync(evt.Id);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        logger.LogError(ex, <span style="color:#e6db74">&#34;ERROR Publishing integration event: {IntegrationEventId} from {AppName} - ({@IntegrationEvent})&#34;</span>, evt.Id, nameof(IntegrationEventLogTest), evt);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> eventLogService.MarkEventAsFailedAsync(evt.Id);
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div>
<h3 id="eventbuswrapper">EventBusWrapper</h3>
<p>This class wraps original <code>IEventBus</code> service to re-use. It&rsquo;s helpful when we want to use the self-defined event bus interface like <code>IMyEventBus</code> instead of using <code>IEventBus&lt;MyType&gt;</code></p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    ...
</span></span><span style="display:flex; background-color:#3c3d38"><span>    <span style="color:#66d9ef">using</span> Juice.EventBus;
</span></span><span style="display:flex; background-color:#3c3d38"><span>    <span style="color:#66d9ef">using</span> Juice.EventBus.IntegrationEventLog.EF;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TypedBroker1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">ITypedBroker1</span> : IEventBus&lt;TypedBroker1&gt;
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyEventBusWrapper</span> : EventBusWrapper, ITypedBroker1
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> MyEventBusWrapper(IEventBus&lt;TypedBroker1&gt; eventBus) : <span style="color:#66d9ef">base</span>(eventBus)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Register</span>
</span></span><span style="display:flex;"><span>    services.AddEventBusWrapper&lt;ITypedBroker1, MyEventBusWrapper&gt;();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Injection</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> eventBus = serviceProvider.GetRequiredService&lt;ITypedBroker1&gt;();</span></span></code></pre></div>
<p>The library can be accessed via Nuget:</p>
<ul>
<li><a href="https://www.nuget.org/packages/Juice.EventBus.IntegrationEventLog.EF" rel="external" target="_blank">Juice.EventBus.IntegrationEventLog.EF</a></li>
<li><a href="https://www.nuget.org/packages/Juice.EventBus.IntegrationEventLog.EF.SqlServer" rel="external" target="_blank">Juice.EventBus.IntegrationEventLog.EF.SqlServer</a></li>
<li><a href="https://www.nuget.org/packages/Juice.EventBus.IntegrationEventLog.EF.PostgreSQL" rel="external" target="_blank">Juice.EventBus.IntegrationEventLog.EF.PostgreSQL</a></li>
</ul>

  <footer class="footline">
              <i class='fa-fw fas fa-calendar'></i> Apr 3, 2023
  </footer>
</article>
        </div>
      </main>
    </div>
    <aside id="R-sidebar" class="default-animation">
      <div id="R-header-topbar" class="default-animation"></div>
      <div id="R-header-wrapper" class="default-animation">
        <div id="R-header" class="default-animation">

        </div>
        <search><form action="/search/index.html" method="get">
          <div class="searchbox default-animation">
            <button class="search-detail" type="submit" title="Search (CTRL+ALT+f)"><i class="fas fa-search"></i></button>
            <label class="a11y-only" for="R-search-by">Search</label>
            <input data-search-input id="R-search-by" name="search-by" class="search-by" type="search" placeholder="Search...">
            <button class="search-clear" type="button" data-search-clear="" title="Clear search"><i class="fas fa-times" title="Clear search"></i></button>
          </div>
        </form></search>
      </div>
      <div id="R-homelinks" class="default-animation homelinks">
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-homelinks">
          <ul class="space collapsible-menu">
            <li class="" data-nav-id="/index.html"><a class="padding" href="/index.html"><i class="fa-fw fas fa-home"></i> Home</a></li>
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-headercontrols">
          <ul class="">
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
      </div>
      <div id="R-content-wrapper" class="highlightable">
        <div class="R-sidebarmenu R-shortcutmenu-main">
          <ul class="enlarge morespace collapsible-menu">
            <li class="" data-nav-id="/overview/index.html"><a class="padding" href="/overview/index.html"><b>1. </b>Overview</a><ul id="R-subsections-0545e563276d3ac6e3218cfecf67a14b" class="collapsible-menu"></ul></li>
            <li class="" data-nav-id="/quickstart/index.html"><a class="padding" href="/quickstart/index.html"><b>2. </b>Quickstarts</a><ul id="R-subsections-d63193e927818b6cb77d9c791ea48a61" class="collapsible-menu"></ul></li>
            <li class="parent " data-nav-id="/core/index.html"><a class="padding" href="/core/index.html"><b>3. </b>Core features</a><ul id="R-subsections-ae20cee98ae962b39919c99c9fa7e1c8" class="collapsible-menu">
            <li class="" data-nav-id="/core/overview/index.html"><a class="padding" href="/core/overview/index.html">Overview</a></li>
            <li class="alwaysopen " data-nav-id="/core/logging/index.html"><a class="padding" href="/core/logging/index.html">Logging</a><ul id="R-subsections-75db7930ffb434daa8a1fb726f7e1cd3" class="collapsible-menu"></ul></li>
            <li class="" data-nav-id="/core/configuration/index.html"><a class="padding" href="/core/configuration/index.html">Configuration</a></li>
            <li class="" data-nav-id="/core/options/index.html"><a class="padding" href="/core/options/index.html">Options</a></li>
            <li class="" data-nav-id="/core/swagger/index.html"><a class="padding" href="/core/swagger/index.html">Swagger</a></li>
            <li class="" data-nav-id="/core/mediator/index.html"><a class="padding" href="/core/mediator/index.html">Mediator</a></li>
            <li class="active parent alwaysopen " data-nav-id="/core/eventbus/index.html"><a class="padding" href="/core/eventbus/index.html">Event bus</a><ul id="R-subsections-8bb47dd787c6a0c9079dde618735fec8" class="collapsible-menu">
            <li class="" data-nav-id="/core/eventbus/breaking/index.html"><a class="padding" href="/core/eventbus/breaking/index.html">Breaking changes</a></li>
            <li class="" data-nav-id="/core/eventbus/v7.x/index.html"><a class="padding" href="/core/eventbus/v7.x/index.html">v7.x</a></li></ul></li>
            <li class="" data-nav-id="/core/entityframework/index.html"><a class="padding" href="/core/entityframework/index.html">Entity framework</a></li>
            <li class="" data-nav-id="/core/integration/index.html"><a class="padding" href="/core/integration/index.html">Integration service</a></li>
            <li class="alwaysopen " data-nav-id="/core/xunit/index.html"><a class="padding" href="/core/xunit/index.html">xUnit</a><ul id="R-subsections-b6ad7eb3f731b9e4ca13d5d5f27cf7cb" class="collapsible-menu"></ul></li>
            <li class="" data-nav-id="/core/multitenant/index.html"><a class="padding" href="/core/multitenant/index.html">Multi-tenant</a></li>
            <li class="" data-nav-id="/core/modular/index.html"><a class="padding" href="/core/modular/index.html">Modular</a></li></ul></li>
            <li class="" data-nav-id="/bg_service/index.html"><a class="padding" href="/bg_service/index.html"><b>4. </b>Background service</a><ul id="R-subsections-91ddeaef7589de0de564e5ca3c5ae84c" class="collapsible-menu"></ul></li>
            <li class="" data-nav-id="/other_services/index.html"><a class="padding" href="/other_services/index.html"><b>5. </b>Other services</a><ul id="R-subsections-499bf1af617ed2be177da5b5e1438bc4" class="collapsible-menu"></ul></li>
          </ul>
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-shortcuts">
          <div class="nav-title padding">More</div>
          <ul class="space collapsible-menu">
            <li class="" data-nav-id="https://github.com/creatorflow-io/Juice"><a class="padding" href="https://github.com/creatorflow-io/Juice" rel="external" target="_blank"><i class='fab fa-github'></i> Github repo</a></li>
          </ul>
        </div>
        <div id="R-footer-margin"></div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-footercontrols">
          <ul class="">
          </ul>
        </div>
<div id="R-footer"><p>Built with <a href="https://github.com/McShelby/hugo-theme-relearn" title="love"><i class="fas fa-heart"></i></a> by <a href="https://gohugo.io/">Hugo</a></p></div>
      </div>
    </aside>
    <script src="/js/clipboard/clipboard.min.js?1750824110" defer></script>
    <script src="/js/perfect-scrollbar/perfect-scrollbar.min.js?1750824110" defer></script>
    <script src="/js/theme.min.js?1750824110" defer></script>
  </body>
</html>
